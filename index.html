<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex Wear - Sistema Logístico B2B</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- ESTILO (CSS) --- */
        :root {
            --primary-color: #001f3f; 
            --secondary-color: #0074D9; 
            --bg-color: #f4f7f6;
            --text-color: #333;
            --card-bg: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 50px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* Header */
        header { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 20px 0; 
            position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }
        
        .carrinho-icon { position: relative; cursor: pointer; font-size: 1.4rem; transition: transform 0.2s; }
        .carrinho-icon:hover { transform: scale(1.1); }
        #contador-carrinho {
            position: absolute; top: -8px; right: -10px;
            background-color: #FF4136; color: white;
            font-size: 0.75rem; padding: 2px 6px;
            border-radius: 50%; border: 2px solid var(--primary-color);
        }

        /* Hero */
        .hero { text-align: center; padding: 40px 0; }
        .hero h2 { color: var(--primary-color); font-size: 2rem; margin-bottom: 10px; }

        /* Grid */
        .grid-produtos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--card-bg); border-radius: 10px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            display: flex; flex-direction: column;
            border: 1px solid #e1e1e1;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .img-box {
            height: 200px; 
            background-color: white; 
            display: flex; align-items: center; justify-content: center; 
            border-bottom: 1px solid #eee;
            padding: 10px; 
        }
        
        .img-box img {
            max-width: 150%;
            max-height: 100%;
            object-fit: contain; 
        }

        .card-details { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card h3 { font-size: 1.1rem; margin-bottom: 5px; color: var(--primary-color); }
        .codigo-ref { font-size: 0.8rem; color: #999; margin-bottom: 10px; }
        .card .preco { font-size: 1.3rem; font-weight: bold; color: var(--secondary-color); margin: 5px 0; }

        .compra-controls { display: flex; gap: 10px; margin-top: 15px; }
        .qtd-input { width: 60px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-weight: bold; }
        .btn-add { flex-grow: 1; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        .btn-add:hover { background-color: var(--secondary-color); }

        /* Sidebar Carrinho */
        .carrinho-sidebar {
            position: fixed; top: 0; right: -500px;
            width: 450px; 
            max-width: 100vw;
            height: 100%; background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.4s ease; z-index: 200;
            display: flex; flex-direction: column;
        }
        .carrinho-sidebar.open { right: 0; }
        .carrinho-header { background: var(--primary-color); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .carrinho-items { flex-grow: 1; padding: 20px; overflow-y: auto; }
        
        .item-carrinho { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .item-info h4 { font-size: 0.95rem; margin-bottom: 4px; }
        .item-subtotal { color: var(--secondary-color); font-weight: bold; font-size: 0.9rem; }

        /* Controles Quantidade no Carrinho */
        .qtd-selector-carrinho {
            display: flex; align-items: center; gap: 5px; margin-top: 5px;
            background: #f0f0f0; padding: 2px; border-radius: 4px; width: fit-content;
        }
        .btn-mini {
            width: 24px; height: 28px; border: none; background: white;
            border-radius: 3px; cursor: pointer; font-weight: bold; color: var(--primary-color);
            display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .btn-mini:hover { background: #ddd; }
        
        .qtd-input-carrinho {
            width: 50px; height: 28px; text-align: center; border: 1px solid #ddd;
            border-radius: 3px; font-weight: bold; font-size: 0.9rem;
        }
        .qtd-input-carrinho::-webkit-outer-spin-button,
        .qtd-input-carrinho::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Área de Frete */
        .frete-container { padding: 15px 20px; background-color: #eef2f5; border-top: 1px solid #ddd; }
        
        .retirada-box {
            background: white; border: 1px solid #ccc; padding: 10px; border-radius: 5px;
            margin-bottom: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .retirada-box:hover { background: #f9f9f9; }
        .retirada-box input { transform: scale(1.3); cursor: pointer; }
        .retirada-box label { font-size: 0.95rem; font-weight: bold; cursor: pointer; color: var(--primary-color); }

        .frete-input-group { display: flex; gap: 5px; margin-top: 5px; }
        .frete-input-group input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        #input-cep { flex: 2; min-width: 0; } 
        #input-numero { flex: 1; min-width: 0; }
        
        .btn-calc-frete { 
            padding: 8px 15px; 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            flex-shrink: 0; 
        }
        .btn-calc-frete:hover { background: var(--secondary-color); }
        .btn-calc-frete:disabled { background: #ccc; cursor: not-allowed; }
        
        .frete-status { font-size: 0.85rem; color: #666; margin-top: 5px; text-align: right; font-weight: bold; }

        /* Footer Carrinho */
        .carrinho-footer { padding: 25px; background: #f9f9f9; border-top: 1px solid #ddd; }
        .resumo-linha { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #555; }
        .total-texto { font-size: 1.3rem; display: flex; justify-content: space-between; font-weight: bold; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px; color: var(--primary-color); }
        .btn-checkout { width: 100%; padding: 15px; background: #2ECC40; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 300; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 450px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .btn-pagar { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-cancelar { width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        
        .aviso-agendamento {
            background-color: #fff3cd; color: #856404; padding: 10px; 
            border: 1px solid #ffeeba; border-radius: 5px; margin-bottom: 15px; font-size: 0.9rem;
            display: none; 
        }

    </style>
</head>
<body>

    <header>
        <div class="container header-content">
            <div class="logo">Vortex Wear</div>
            <div class="carrinho-icon" onclick="toggleCarrinho()">
                <i class="fas fa-shopping-cart"></i>
                <span id="contador-carrinho">0</span>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="hero">
            <h2>Logística Integrada B2B</h2>
            <p>Venda por atacado: Mínimo 15 unidades (Cores Variadas).</p>
        </section>

        <section id="vitrine" class="grid-produtos"></section>
    </main>

    <div id="sidebar-carrinho" class="carrinho-sidebar">
        <div class="carrinho-header">
            <h3><i class="fas fa-clipboard-list"></i> Orçamento</h3>
            <button onclick="toggleCarrinho()" class="close-btn">&times;</button>
        </div>
        
        <div id="itens-carrinho" class="carrinho-items"></div>

        <div class="frete-container">
            <div class="retirada-box" onclick="toggleRetirada()">
                <input type="checkbox" id="check-retirada">
                <label for="check-retirada">Vou retirar na empresa (Frete Grátis)</label>
            </div>

            <label style="font-weight:bold; font-size:0.9rem">Entrega (CEP e Número):</label>
            <div class="frete-input-group">
                <input type="text" id="input-cep" placeholder="CEP (00000-000)" maxlength="9">
                <input type="text" id="input-numero" placeholder="Nº" maxlength="6">
                <button class="btn-calc-frete" onclick="calcularFreteAPI()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="frete-status" class="frete-status">Digite CEP e Número.</div>
        </div>

        <div class="carrinho-footer">
            <div class="resumo-linha">
                <span>Subtotal Itens:</span>
                <span id="subtotal-preco">R$ 0,00</span>
            </div>
            <div class="resumo-linha">
                <small id="info-caixas" style="color:#666; font-size:0.8rem; margin-right:5px"></small>
                <span>Frete (Logística):</span>
                <span id="frete-preco" style="color:var(--primary-color); font-weight:bold">R$ 0,00</span>
            </div>
            <div class="total-texto">
                <span>Total Geral:</span>
                <span id="total-final">R$ 0,00</span>
            </div>
            <button onclick="irParaPagamento()" class="btn-checkout">Finalizar Pedido</button>
        </div>
    </div>

    <div id="modal-pagamento" class="modal-overlay">
        <div class="modal-content">
            <h3>Concluir Pedido</h3>
            
            <div id="msg-agendamento" class="aviso-agendamento">
                <i class="fas fa-info-circle"></i> <strong>Atenção:</strong> Como você escolheu retirar no local, nossa equipe entrará em contato para agendar o horário da coleta.
            </div>

            <form id="form-pagamento" onsubmit="finalizarPedido(event)">
                <div class="form-group">
                    <label>Empresa / Responsável</label>
                    <input type="text" id="input-nome" placeholder="Nome completo" required>
                </div>
                <div class="form-group">
                    <label>Contato (Tel/WhatsApp)</label>
                    <input type="text" id="input-telefone" placeholder="(11) 99999-9999" required>
                </div>
                <div class="form-group">
                    <label>Forma de Pagamento</label>
                    <select id="select-pagamento">
                        <option>Boleto (30 dias)</option>
                        <option>Cartão Corporativo</option>
                        <option>Transferência</option>
                    </select>
                </div>
                <button type="submit" class="btn-pagar" id="btn-finalizar-texto">
                    <i class="fas fa-check-circle"></i> Gerar Pedido e Enviar
                </button>
                <button type="button" onclick="fecharPagamento()" class="btn-cancelar">Voltar</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO (GOOGLE SHEETS E DADOS) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9C6nlq_RrNEzXwME5TdA6p3AQ59cmFYj8I7hAZO7TKsdDFK0C454ShS1bgc6LzWSpEA/exec";
        const ORIGEM = { lat: -23.6646, lon: -46.7645 }; // Embu das Artes/SP
        const PRECO_POR_KM = 3.30;
        const UNIDADES_POR_CAIXA = 15;
        const QTD_MINIMA = 15; 

        // --- LISTA DE PRODUTOS ---
        const produtos = [
            { id: 1, nome: "Corta Vento Azul marinho", ref: "EPI-001", preco: 99.99, imagem: "imagens/corta-vento-azul-marinho.png" },
            { id: 2, nome: "Corta Vento Preto", ref: "EPI-002", preco: 99.99, imagem: "imagens/corta-vento-preto.png" },
            { id: 3, nome: "Corta Vento Branco", ref: "EPI-003", preco: 99.99, imagem: "imagens/corta-vento-branco.png" },
            { id: 4, nome: "Corta Vento Cinza", ref: "EPI-004", preco: 99.99, imagem: "imagens/corta-vento-cinza.png" },
            { id: 5, nome: "Corta Vento Marsala", ref: "EPI-005", preco: 99.99, imagem: "imagens/corta-vento-marsala.png" },
            { id: 6, nome: "Corta Vento Laranja", ref: "EPI-006", preco: 99.99, imagem: "imagens/corta-vento-laranja.png" },
            { id: 7, nome: "Corta Vento Verde Militar", ref: "EPI-007", preco: 99.99, imagem: "imagens/corta-vento-musgo.png" },
            { id: 8, nome: "Corta Vento Rosa", ref: "EPI-008", preco: 99.99, imagem: "imagens/corta-vento-rosa.png" },
            { id: 9, nome: "Corta Vento Vermelho", ref: "EXT-009", preco: 99.99, imagem: "imagens/corta-vento-vermelho.png" },
            { id: 10, nome: "Corta Vento Marrom", ref: "MED-010", preco: 99.99, imagem: "imagens/corta-vento-areia.png" }
        ];

        let carrinho = [];
        let custoFreteUnitario = 0; 

        // Renderiza Vitrine
        function renderizarProdutos() {
            const vitrine = document.getElementById('vitrine');
            vitrine.innerHTML = "";
            produtos.forEach(produto => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="img-box">
                        <img src="${produto.imagem}" alt="${produto.nome}" onerror="this.style.display='none'; this.parentNode.innerHTML='SEM FOTO'">
                    </div>
                    <div class="card-details">
                        <div>
                            <h3>${produto.nome}</h3>
                            <p class="codigo-ref">Ref: ${produto.ref}</p>
                            <p class="preco">R$ ${produto.preco.toFixed(2).replace('.', ',')}</p>
                        </div>
                        <div class="compra-controls">
                            <input type="number" id="qtd-${produto.id}" class="qtd-input" value="1" min="1">
                            <button class="btn-add" onclick="adicionarAoCarrinho(${produto.id})">
                                <i class="fas fa-plus"></i> Incluir
                            </button>
                        </div>
                    </div>
                `;
                vitrine.appendChild(card);
            });
        }

        // --- 2. SISTEMA DE RETIRADA vs ENTREGA ---
        function toggleRetirada() {
            setTimeout(() => {
                const checkbox = document.getElementById('check-retirada');
                const cepInput = document.getElementById('input-cep');
                const numInput = document.getElementById('input-numero');
                const btnCalc = document.querySelector('.btn-calc-frete');
                const statusDiv = document.getElementById('frete-status');

                if (checkbox.checked) {
                    cepInput.disabled = true;
                    numInput.disabled = true;
                    btnCalc.disabled = true;
                    cepInput.value = ""; 
                    numInput.value = "";
                    statusDiv.innerText = "Coleta na Fábrica (Agendar)";
                    statusDiv.style.color = "var(--primary-color)";
                } else {
                    cepInput.disabled = false;
                    numInput.disabled = false;
                    btnCalc.disabled = false;
                    statusDiv.innerText = "Digite CEP e Número.";
                    statusDiv.style.color = "#666";
                    custoFreteUnitario = 0; 
                }
                atualizarTotais();
            }, 50);
        }

        // --- 3. SISTEMA DE FRETE (API) ---
        async function calcularFreteAPI() {
            const cepInput = document.getElementById('input-cep').value.replace(/\D/g, '');
            const statusDiv = document.getElementById('frete-status');

            if (cepInput.length !== 8) {
                statusDiv.innerText = "CEP Inválido";
                statusDiv.style.color = "red";
                custoFreteUnitario = 0;
                atualizarTotais();
                return;
            }

            statusDiv.innerText = "Calculando rota...";
            statusDiv.style.color = "#0074D9";

            try {
                const response = await fetch(`https://brasilapi.com.br/api/cep/v2/${cepInput}`);
                
                let kmRota = 0;
                let cidadeDestino = "Região SP";

                if (response.ok) {
                    const dados = await response.json();
                    if(dados.city) cidadeDestino = `${dados.city}/${dados.state}`;

                    if (dados.location && dados.location.coordinates) {
                        const lat = parseFloat(dados.location.coordinates.latitude);
                        const lon = parseFloat(dados.location.coordinates.longitude);

                        if (!isNaN(lat) && !isNaN(lon)) {
                            const distanciaLinhaReta = getDistanceFromLatLonInKm(ORIGEM.lat, ORIGEM.lon, lat, lon);
                            kmRota = distanciaLinhaReta * 2.00; // Margem 100%
                            statusDiv.innerText = `Destino: ${cidadeDestino}`;
                            statusDiv.style.color = "green";
                        } else {
                            // Fallback Coordenada Vazia
                            kmRota = 25.00; 
                            statusDiv.innerText = `Destino: ${cidadeDestino} (Estimado)`;
                            statusDiv.style.color = "#2ECC40";
                        }
                    } else {
                        // Fallback Sem Coordenada
                        kmRota = 25.00; 
                        statusDiv.innerText = `Destino: ${cidadeDestino} (Estimado)`;
                        statusDiv.style.color = "#2ECC40";
                    }
                } else {
                    throw new Error("Erro na API");
                }

                custoFreteUnitario = kmRota * PRECO_POR_KM;
                atualizarTotais(); 

            } catch (error) {
                console.log("Usando fallback apresentação");
                custoFreteUnitario = 30.00 * PRECO_POR_KM; 
                statusDiv.innerText = "Rota Calculada (Base Local)";
                statusDiv.style.color = "green";
                atualizarTotais();
            }
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }

        function deg2rad(deg) { return deg * (Math.PI/180) }

        // --- 4. LÓGICA DO CARRINHO ---
        function adicionarAoCarrinho(id) {
            const qtdInput = document.getElementById(`qtd-${id}`);
            const quantidade = parseInt(qtdInput.value);
            
            if (quantidade < 1) {
                alert("A quantidade deve ser pelo menos 1.");
                return;
            }

            const itemExistente = carrinho.find(item => item.id === id);
            if (itemExistente) {
                itemExistente.quantidade += quantidade;
            } else {
                const produtoOriginal = produtos.find(p => p.id === id);
                carrinho.push({ ...produtoOriginal, quantidade: quantidade });
            }
            atualizarTotais();
            
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<i class='fas fa-check'></i>";
            setTimeout(() => { btn.innerHTML = originalText; }, 1000);
        }

        function alterarQuantidadeBotao(index, mudanca) {
            const item = carrinho[index];
            item.quantidade += mudanca;

            if (item.quantidade <= 0) {
                 removerDoCarrinho(index);
            } else {
                 atualizarTotais();
            }
        }

        function alterarQuantidadeInput(index, novoValor) {
            let qtd = parseInt(novoValor);

            if(isNaN(qtd) || qtd <= 0) {
                removerDoCarrinho(index);
            } else {
                carrinho[index].quantidade = qtd;
                atualizarTotais();
            }
        }

        function atualizarTotais() {
            const totalUnidades = carrinho.reduce((acc, item) => acc + item.quantidade, 0);
            document.getElementById('contador-carrinho').innerText = totalUnidades;

            const container = document.getElementById('itens-carrinho');
            container.innerHTML = "";
            let subtotal = 0;

            if (carrinho.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#888'>Carrinho vazio.</p>";
            } else {
                carrinho.forEach((item, index) => {
                    const totalItem = item.preco * item.quantidade;
                    subtotal += totalItem;
                    
                    container.innerHTML += `
                        <div class="item-carrinho">
                            <div class="item-info">
                                <h4>${item.nome}</h4>
                                <div class="qtd-selector-carrinho">
                                    <button class="btn-mini" onclick="alterarQuantidadeBotao(${index}, -1)">-</button>
                                    <input type="number" class="qtd-input-carrinho" 
                                           value="${item.quantidade}" 
                                           onchange="alterarQuantidadeInput(${index}, this.value)">
                                    <button class="btn-mini" onclick="alterarQuantidadeBotao(${index}, 1)">+</button>
                                </div>
                                <small>Unit: R$ ${item.preco.toFixed(2)}</small>
                            </div>
                            <span class="item-subtotal">R$ ${totalItem.toFixed(2)}</span>
                            <button onclick="removerDoCarrinho(${index})" style="color:red;border:none;background:none;cursor:pointer;margin-left:5px"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                });
            }

            const totalCaixas = Math.ceil(totalUnidades / UNIDADES_POR_CAIXA);
            let multiplicadorFrete = Math.ceil(totalCaixas / 10);
            if (totalUnidades === 0) multiplicadorFrete = 0;

            const isRetirada = document.getElementById('check-retirada').checked;
            let freteFinal = 0;

            if (isRetirada) {
                freteFinal = 0;
                if(totalUnidades > 0) document.getElementById('info-caixas').innerText = `Volume: ${totalCaixas} caixas`;
            } else {
                freteFinal = custoFreteUnitario * multiplicadorFrete;
                if(totalUnidades > 0) {
                    document.getElementById('info-caixas').innerText = `Volume: ${totalCaixas} caixas (${multiplicadorFrete}x Frete)`;
                } else {
                    document.getElementById('info-caixas').innerText = "";
                }
            }

            document.getElementById('subtotal-preco').innerText = "R$ " + subtotal.toFixed(2).replace('.', ',');
            if(isNaN(freteFinal)) freteFinal = 0;
            document.getElementById('frete-preco').innerText = "R$ " + freteFinal.toFixed(2).replace('.', ',');
            const totalGeral = subtotal + freteFinal;
            document.getElementById('total-final').innerText = "R$ " + totalGeral.toFixed(2).replace('.', ',');
        }

        function removerDoCarrinho(index) {
            carrinho.splice(index, 1);
            atualizarTotais();
        }

        function toggleCarrinho() {
            document.getElementById('sidebar-carrinho').classList.toggle('open');
        }

        function irParaPagamento() {
            if (carrinho.length === 0) {
                alert("O carrinho está vazio.");
                return;
            }

            const totalUnidades = carrinho.reduce((acc, item) => acc + item.quantidade, 0);
            if (totalUnidades < QTD_MINIMA) {
                alert(`ATENÇÃO:\nO pedido mínimo para atacado é de ${QTD_MINIMA} peças (1 Caixa).\n\nVocê selecionou apenas ${totalUnidades} peças no total.\nAdicione mais itens para fechar a caixa.`);
                return;
            }

            const isRetirada = document.getElementById('check-retirada').checked;
            const numInput = document.getElementById('input-numero').value;
            
            if (!isRetirada) {
                if(custoFreteUnitario === 0) {
                    const cep = document.getElementById('input-cep').value;
                    if(cep.length >= 8) {
                        calcularFreteAPI().then(() => {
                            abrirModalCheckout(isRetirada);
                        });
                    } else {
                        alert("Por favor, digite o CEP ou selecione 'Retirar na empresa'.");
                    }
                    return;
                }
            }

            abrirModalCheckout(isRetirada);
        }

        function abrirModalCheckout(isRetirada) {
            toggleCarrinho();
            const modal = document.getElementById('modal-pagamento');
            const aviso = document.getElementById('msg-agendamento');
            const btnTexto = document.getElementById('btn-finalizar-texto');
            
            if(isRetirada) {
                aviso.style.display = 'block';
                btnTexto.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Compra';
            } else {
                aviso.style.display = 'none';
                btnTexto.innerHTML = '<i class="fas fa-check-circle"></i> Finalizar Compra';
            }

            modal.classList.add('active');
        }

        function fecharPagamento() {
            document.getElementById('modal-pagamento').classList.remove('active');
        }

        // --- FUNÇÃO PRINCIPAL: SALVA DADOS, GERA PDF E ABRE WHATSAPP ---
        function finalizarPedido(event) {
            event.preventDefault();
            
            const telInput = document.getElementById('input-telefone');
            const telNumeros = telInput.value.replace(/\D/g, '');

            if (telNumeros.length < 11) {
                alert("Erro: O telefone precisa ter o DDD + 9 dígitos (Total 11 números).");
                telInput.focus();
                return; 
            }

            const btn = document.querySelector('.btn-pagar');
            const textoOriginal = btn.innerHTML;
            btn.innerText = "Registrando...";
            btn.disabled = true;

            // 1. DADOS
            const ultimos4Telefone = telNumeros.slice(-4);
            const aleatorio4 = Math.floor(1000 + Math.random() * 9000);
            const pedidoID = `PED-${ultimos4Telefone}-${aleatorio4}`;
            
            const nome = document.getElementById('input-nome').value;
            const pagamento = document.getElementById('select-pagamento').value;
            const isRetirada = document.getElementById('check-retirada').checked;
            const totalGeral = document.getElementById('total-final').innerText;
            const cep = document.getElementById('input-cep').value;
            const numeroCasa = document.getElementById('input-numero').value;

            let resumoItens = "";
            carrinho.forEach(item => {
                resumoItens += `${item.quantidade}x ${item.nome} | `;
            });

            let enderecoFinal = isRetirada ? "RETIRADA NA LOJA" : `CEP ${cep}, Nº ${numeroCasa}`;

            // 2. ENVIAR PARA O GOOGLE SHEETS
            const formData = new FormData();
            formData.append('ID Pedido', pedidoID);
            formData.append('Cliente', nome);
            formData.append('Telefone', telInput.value);
            formData.append('Valor Total', totalGeral);
            formData.append('Tipo Entrega', isRetirada ? 'Retirada' : 'Entrega');
            formData.append('Endereço', enderecoFinal);
            formData.append('Itens', resumoItens);

            fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => {
                console.log('Sucesso no banco de dados!');
                gerarPDFecZAP(pedidoID, nome, telInput.value, pagamento, isRetirada, totalGeral, cep, numeroCasa, btn, textoOriginal);
            })
            .catch(error => {
                console.error('Erro ao salvar!', error);
                // Mesmo com erro na planilha, segue o fluxo para o cliente não travar
                gerarPDFecZAP(pedidoID, nome, telInput.value, pagamento, isRetirada, totalGeral, cep, numeroCasa, btn, textoOriginal);
            });
        }

        function gerarPDFecZAP(pedidoID, nome, telefone, pagamento, isRetirada, totalGeral, cep, numeroCasa, btn, textoOriginal) {
            btn.innerText = "Gerando PDF...";

            // GERAÇÃO DO PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const fileName = `${pedidoID}.pdf`;

            doc.setFontSize(22);
            doc.setTextColor(0, 31, 63);
            doc.text("VORTEX WEAR", 105, 20, null, null, "center");
            
            doc.setFontSize(14);
            doc.setTextColor(50);
            doc.text(`PEDIDO - ${pedidoID}`, 105, 30, null, null, "center");

            doc.setLineWidth(0.5);
            doc.line(20, 35, 190, 35);

            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(`Cliente: ${nome.toUpperCase()}`, 20, 45);
            doc.text(`Contato: ${telefone}`, 20, 52);
            doc.text(`Pagamento: ${pagamento}`, 20, 59);
            
            if(isRetirada) {
                doc.setTextColor(0, 100, 0); 
                doc.text("Entrega: RETIRADA NO LOCAL", 20, 66);
            } else {
                doc.text(`Entrega: TRANSPORTADORA`, 20, 66);
                doc.text(`Endereço: CEP ${cep}, Nº ${numeroCasa}`, 20, 73);
            }

            const dadosTabela = carrinho.map(item => [
                item.nome,
                item.quantidade,
                "R$ " + item.preco.toFixed(2),
                "R$ " + (item.preco * item.quantidade).toFixed(2)
            ]);

            doc.autoTable({
                startY: 85,
                head: [['Produto', 'Qtd', 'Unit', 'Total']],
                body: dadosTabela,
                theme: 'striped',
                headStyles: { fillColor: [0, 31, 63] },
                styles: { fontSize: 10 }
            });

            let finalY = doc.lastAutoTable.finalY + 10;
            const freteVal = document.getElementById('frete-preco').innerText;
            const subtotal = document.getElementById('subtotal-preco').innerText;

            doc.text(`Subtotal: ${subtotal}`, 140, finalY);
            doc.text(`Frete: ${freteVal}`, 140, finalY + 7);
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: ${totalGeral}`, 140, finalY + 16);

            // BAIXA O PDF
            doc.save(fileName);

            // ABRE O WHATSAPP
            const textoZap = `Olá! Realizei o pedido *${pedidoID}* no site.\nCliente: ${nome}\nValor: ${totalGeral}\n\n*Estou enviando o PDF com os detalhes em anexo.*`;
            const numeroDestino = "5511975524934";
            const linkZap = `https://wa.me/${numeroDestino}?text=${encodeURIComponent(textoZap)}`;

            setTimeout(() => {
                window.open(linkZap, '_blank');
                alert("PEDIDO REGISTRADO!\n\n1. Dados salvos no sistema.\n2. PDF baixado no seu dispositivo.\n3. O WhatsApp foi aberto para envio.");
                location.reload(); 
            }, 1500);
        }

        renderizarProdutos();
    </script>
</body>
</html>